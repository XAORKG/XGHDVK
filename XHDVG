task.wait(0.5)
local Players = game:GetService("Players")
local workspace = game:GetService("Workspace")
local Player = Players.LocalPlayer

local msg1 = Instance.new("Message", workspace)
msg1.Text = "欢迎你的使用"
task.wait(4)
msg1:Destroy()

local msg2 = Instance.new("Message", workspace)
msg2.Text = "有问题请联系作者作者QQ:3491629303"
task.wait(6)
msg2:Destroy()

local msg3 = Instance.new("Message", workspace)
msg3.Text = "已检测到你("..Player.Name..")加入了游戏"
task.wait(3)
msg3:Destroy()

local msg4 = Instance.new("Message", workspace)
msg4.Text = "正在加载数据中大概10秒左右……"
task.wait(15)
msg4:Destroy()
loadstring(game:HttpGet("https://raw.githubusercontent.com/XAORKG/XGHDVK/refs/heads/main/XYOP"))()
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local workspace = game:GetService("Workspace")

local Player = Players.LocalPlayer
local PlayerGui = Player:WaitForChild("PlayerGui", 60)
if not PlayerGui then warn("获取PlayerGui失败，UI无法创建") return end

_G.FastAttack = _G.FastAttack ~= nil and _G.FastAttack or true
local _ENV = (getgenv or getrenv or getfenv)()

if _G.FastAttack then
    local function SafeWaitForChild(parent, childName)
        local success, result = pcall(function()
            return parent:WaitForChild(childName, 10)
        end)
        if not success or not result then
            warn("未找到组件: " .. childName)
        end
        return result
    end

    local function WaitChilds(path, ...)
        local last = path
        for _, child in {...} do
            last = last:FindFirstChild(child) or SafeWaitForChild(last, child)
            if not last then break end
        end
        return last
    end

    -- 核心修改：函数返回最新组件，不缓存全局变量
    local function CheckAndGetCoreComponents()
        local Remotes, Modules, Net, RegisterAttack, RegisterHit, Enemies = nil, nil, nil, nil, nil, nil
        while true do
            Remotes = SafeWaitForChild(ReplicatedStorage, "Remotes")
            Modules = SafeWaitForChild(ReplicatedStorage, "Modules")
            Net = Modules and SafeWaitForChild(Modules, "Net") or nil
            RegisterAttack = Net and SafeWaitForChild(Net, "RE/RegisterAttack") or nil
            RegisterHit = Net and SafeWaitForChild(Net, "RE/RegisterHit") or nil
            Enemies = SafeWaitForChild(workspace, "Enemies")
            
            if Remotes and Modules and Net and RegisterAttack and RegisterHit and Enemies then
                return Remotes, Net, RegisterAttack, RegisterHit, Enemies -- 返回实时组件
            end
            warn("核心组件缺失，持续重试中...")
            task.wait(1)
        end
    end

    -- 首次启动检查（确保初始组件可用）
    local initialRemotes, initialNet, initialRegisterAttack, initialRegisterHit, initialEnemies = CheckAndGetCoreComponents()

    local Validator = initialRemotes and SafeWaitForChild(initialRemotes, "Validator") or nil
    local CommF = initialRemotes and SafeWaitForChild(initialRemotes, "CommF_") or nil
    local CommE = initialRemotes and SafeWaitForChild(initialRemotes, "CommE") or nil
    local WorldOrigin = SafeWaitForChild(workspace, "_WorldOrigin")

    local Settings = {
        AutoClick = true,
        ClickDelay = 0.3
    }

    local Module = {}

    Module.FastAttack = (function()
        if _ENV.rz_FastAttack then
            return _ENV.rz_FastAttack
        end

        local FastAttack = {
            Distance = 50,
            attackMobs = true,
            attackPlayers = true,
            Equipped = nil,
            IsRunning = true,
            consecutiveFailures = 0,
            maxConsecutiveFailures = 5
        }

        local function IsAlive(character)
            if not character then return false end
            local humanoid = character:FindFirstChildOfClass("Humanoid")
            if not humanoid then return false end
            return humanoid.Health and humanoid.Health > 0
        end

        local function ProcessEnemies(OthersEnemies, Folder)
            if not Folder or not FastAttack.attackMobs then return nil end
            local BasePart = nil
            for _, Enemy in Folder:GetChildren() do
                if Enemy == Player.Character or not IsAlive(Enemy) then continue end
                local targetParts = {"Head", "Torso", "UpperTorso", "HumanoidRootPart"}
                local foundPart = nil
                for _, partName in ipairs(targetParts) do
                    foundPart = Enemy:FindFirstChild(partName)
                    if foundPart then break end
                end
                if foundPart and Player:DistanceFromCharacter(foundPart.Position) < FastAttack.Distance then
                    table.insert(OthersEnemies, {Enemy, foundPart})
                    BasePart = foundPart
                end
            end
            return BasePart
        end

        local function ProcessRealPlayers(OthersEnemies)
            if not FastAttack.attackPlayers then return nil end
            local BasePart = nil
            for _, OtherPlayer in Players:GetPlayers() do
                if OtherPlayer == Player then continue end
                local OtherChar = OtherPlayer.Character
                if not IsAlive(OtherChar) then continue end
                local targetParts = {"Head", "Torso", "UpperTorso", "HumanoidRootPart"}
                local foundPart = nil
                for _, partName in ipairs(targetParts) do
                    foundPart = OtherChar:FindFirstChild(partName)
                    if foundPart then break end
                end
                if foundPart and Player:DistanceFromCharacter(foundPart.Position) < FastAttack.Distance then
                    table.insert(OthersEnemies, {OtherChar, foundPart})
                    BasePart = foundPart
                end
            end
            return BasePart
        end

        -- 每次攻击都获取最新组件（核心修复）
        function FastAttack:Attack(BasePart, OthersEnemies)
            local _, Net, temp_RegisterAttack, temp_RegisterHit, _ = CheckAndGetCoreComponents()
            if not (BasePart and OthersEnemies and #OthersEnemies > 0 and temp_RegisterAttack and temp_RegisterHit) then
                self.consecutiveFailures = self.consecutiveFailures + 1
                if self.consecutiveFailures >= self.maxConsecutiveFailures then
                    self.consecutiveFailures = 0
                    self.Equipped = Player.Character and IsAlive(Player.Character) and Player.Character:FindFirstChildOfClass("Tool")
                end
                task.delay(0.5, function() self:AttackNearest() end)
                return
            end
            self.consecutiveFailures = 0
            temp_RegisterAttack:FireServer(Settings.ClickDelay or 0)
            temp_RegisterHit:FireServer(BasePart, OthersEnemies)
        end

        -- 实时获取Enemies组件
        function FastAttack:AttackNearest()
            if not self.IsRunning then return end
            local _, _, _, _, Enemies = CheckAndGetCoreComponents()
            local OthersEnemies = {}
            local Part1 = ProcessEnemies(OthersEnemies, Enemies)
            local Part2 = ProcessRealPlayers(OthersEnemies)
            if #OthersEnemies > 0 then
                self:Attack(Part1 or Part2, OthersEnemies)
            else
                task.wait(0)
            end
        end

        function FastAttack:BladeHits()
            if not self.IsRunning then return end
            local Equipped = Player.Character and IsAlive(Player.Character) and Player.Character:FindFirstChildOfClass("Tool")
            if Equipped and Equipped.ToolTip ~= "Gun" then
                self:AttackNearest()
            else
                task.wait(0)
            end
        end

        task.spawn(function()
            while true do
                task.wait(Settings.ClickDelay)
                if Settings.AutoClick and FastAttack.IsRunning then
                    FastAttack:BladeHits()
                else
                    task.wait(0.1)
                end
            end
        end)

        _ENV.rz_FastAttack = FastAttack
        return FastAttack
    end)()
end

-- UI部分保持不变
local FastAttackUI = Instance.new("ScreenGui")
FastAttackUI.Name = "FastAttackUI"
FastAttackUI.Parent = PlayerGui
FastAttackUI.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
FastAttackUI.DisplayOrder = 100
FastAttackUI.ResetOnSpawn = false

local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0, 158, 0, 95)
MainFrame.Position = UDim2.new(0.7, 0, 0.1, 0)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
MainFrame.BackgroundTransparency = 0.4
MainFrame.BorderColor3 = Color3.fromRGB(255, 215, 0)
MainFrame.ClipsDescendants = true
MainFrame.Parent = FastAttackUI
MainFrame.Active = true
MainFrame.Draggable = true

local TitleBar = Instance.new("TextLabel")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 18)
TitleBar.BackgroundColor3 = Color3.fromRGB(255, 215, 0)
TitleBar.Text = "模型佛范围作者:3491629303"
TitleBar.TextColor3 = Color3.fromRGB(0, 0, 0)
TitleBar.TextScaled = true
TitleBar.TextSize = 10
TitleBar.Parent = MainFrame
TitleBar.Selectable = false

local ToggleButton = Instance.new("TextButton")
ToggleButton.Name = "ToggleButton"
ToggleButton.Size = UDim2.new(0.4, 0, 0, 22)
ToggleButton.Position = UDim2.new(0.05, 0, 0, 22)
ToggleButton.BackgroundColor3 = _G.FastAttack and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
ToggleButton.Text = _G.FastAttack and "开" or "关"
ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
ToggleButton.TextScaled = true
ToggleButton.TextSize = 9
ToggleButton.AutoButtonColor = true
ToggleButton.Parent = MainFrame

ToggleButton.MouseButton1Click:Connect(function()
    _G.FastAttack = not _G.FastAttack
    if _ENV.rz_FastAttack then
        _ENV.rz_FastAttack.IsRunning = _G.FastAttack
    end
    ToggleButton.BackgroundColor3 = _G.FastAttack and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
    ToggleButton.Text = _G.FastAttack and "开" or "关"
end)

local RangeLabel = Instance.new("TextLabel")
RangeLabel.Name = "RangeLabel"
RangeLabel.Size = UDim2.new(0.3, 0, 0, 18)
RangeLabel.Position = UDim2.new(0.05, 0, 0, 48)
RangeLabel.BackgroundTransparency = 1
RangeLabel.Text = "范围:"
RangeLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
RangeLabel.TextScaled = true
RangeLabel.TextSize = 8
RangeLabel.Parent = MainFrame

local RangeInput = Instance.new("TextBox")
RangeInput.Name = "RangeInput"
RangeInput.Size = UDim2.new(0.3, 0, 0, 18)
RangeInput.Position = UDim2.new(0.4, 0, 0, 48)
RangeInput.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
RangeInput.TextColor3 = Color3.fromRGB(255, 255, 255)
RangeInput.PlaceholderText = "数"
RangeInput.TextScaled = true
RangeInput.TextSize = 8
RangeInput.ClearTextOnFocus = false
RangeInput.Text = _ENV.rz_FastAttack and tostring(_ENV.rz_FastAttack.Distance) or "500"
RangeInput.Parent = MainFrame

local UnitLabel = Instance.new("TextLabel")
UnitLabel.Name = "UnitLabel"
UnitLabel.Size = UDim2.new(0.15, 0, 0, 18)
UnitLabel.Position = UDim2.new(0.75, 0, 0, 48)
UnitLabel.BackgroundTransparency = 1
UnitLabel.Text = "数"
UnitLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
UnitLabel.TextScaled = true
UnitLabel.TextSize = 8
UnitLabel.Parent = MainFrame

RangeInput.FocusLost:Connect(function(enterPressed)
    if enterPressed and _ENV.rz_FastAttack then
        local inputNum = tonumber(RangeInput.Text)
        local newRange = inputNum and math.floor(math.clamp(inputNum, 1, 2500)) or 10
        RangeInput.Text = tostring(newRange)
        _ENV.rz_FastAttack.Distance = newRange
    end
end)

RunService.RenderStepped:Connect(function()
    if _ENV.rz_FastAttack then
        ToggleButton.BackgroundColor3 = _ENV.rz_FastAttack.IsRunning and Color3.fromRGB(0, 255, 0) or Color3.fromRGB(255, 0, 0)
        ToggleButton.Text = _ENV.rz_FastAttack.IsRunning and "开" or "关"
        if not RangeInput:IsFocused() then
            RangeInput.Text = tostring(_ENV.rz_FastAttack.Distance)
        end
    end
end)

-- 重试逻辑同步修改：实时获取组件
task.spawn(function()
    while true do
        task.wait(1)
        if _ENV.rz_FastAttack then
        else
            warn("⚠️ 快速攻击组件未完全加载，持续尝试恢复...")
            while not _ENV.rz_FastAttack do
                task.wait(0.5)
                if _G.FastAttack then
                    local Remotes, Net, RegisterAttack, RegisterHit, Enemies = CheckAndGetCoreComponents()
                    Module.FastAttack = Module.FastAttack or (function()
                        local FastAttack = {
                            Distance=500, 
                            attackMobs=true, 
                            attackPlayers=true, 
                            Equipped=nil, 
                            IsRunning=true,
                            consecutiveFailures=0,
                            maxConsecutiveFailures=5
                        }

                        local function IsAlive(character)
                            if not character then return false end
                            local humanoid = character:FindFirstChildOfClass("Humanoid")
                            if not humanoid then return false end
                            return humanoid.Health and humanoid.Health > 0
                        end

                        function FastAttack:BladeHits()
                            local Equipped = Player.Character and IsAlive(Player.Character) and Player.Character:FindFirstChildOfClass("Tool")
                            if Equipped and Equipped.ToolTip ~= "Gun" then
                                self:AttackNearest()
                            end
                        end

                        function FastAttack:AttackNearest()
                            if not self.IsRunning then return end
                            local _, _, _, _, Enemies = CheckAndGetCoreComponents()
                            local OthersEnemies = {}
                            local function ProcessEnemies(OthersEnemies, Folder)
                                if not Folder or not FastAttack.attackMobs then return nil end
                                local BasePart = nil
                                for _, Enemy in Folder:GetChildren() do
                                    if Enemy == Player.Character or not IsAlive(Enemy) then continue end
                                    local targetParts = {"Head", "Torso", "UpperTorso", "HumanoidRootPart"}
                                    local foundPart = nil
                                    for _, partName in ipairs(targetParts) do
                                        foundPart = Enemy:FindFirstChild(partName)
                                        if foundPart then break end
                                    end
                                    if foundPart and Player:DistanceFromCharacter(foundPart.Position) < FastAttack.Distance then
                                        table.insert(OthersEnemies, {Enemy, foundPart})
                                        BasePart = foundPart
                                    end
                                end
                                return BasePart
                            end

                            local function ProcessRealPlayers(OthersEnemies)
                                if not FastAttack.attackPlayers then return nil end
                                local BasePart = nil
                                for _, OtherPlayer in Players:GetPlayers() do
                                    if OtherPlayer == Player then continue end
                                    local OtherChar = OtherPlayer.Character
                                    if not IsAlive(OtherChar) then continue end
                                    local targetParts = {"Head", "Torso", "UpperTorso", "HumanoidRootPart"}
                                    local foundPart = nil
                                    for _, partName in ipairs(targetParts) do
                                        foundPart = OtherChar:FindFirstChild(partName)
                                        if foundPart then break end
                                    end
                                    if foundPart and Player:DistanceFromCharacter(foundPart.Position) < FastAttack.Distance then
                                        table.insert(OthersEnemies, {OtherChar, foundPart})
                                        BasePart = foundPart
                                    end
                                end
                                return BasePart
                            end

                            local Part1 = ProcessEnemies(OthersEnemies, Enemies)
                            local Part2 = ProcessRealPlayers(OthersEnemies)
                            if #OthersEnemies > 0 then
                                self:Attack(Part1 or Part2, OthersEnemies)
                            end
                        end

                        function FastAttack:Attack(BasePart, OthersEnemies)
                            local _, Net, temp_RegisterAttack, temp_RegisterHit, _ = CheckAndGetCoreComponents()
                            if not (BasePart and OthersEnemies and #OthersEnemies > 0 and temp_RegisterAttack and temp_RegisterHit) then
                                self.consecutiveFailures = self.consecutiveFailures + 1
                                if self.consecutiveFailures >= self.maxConsecutiveFailures then
                                    self.consecutiveFailures = 0
                                    self.Equipped = Player.Character and IsAlive(Player.Character) and Player.Character:FindFirstChildOfClass("Tool")
                                end
                                task.delay(0.5, function() self:AttackNearest() end)
                                return
                            end
                            self.consecutiveFailures = 0
                            temp_RegisterAttack:FireServer(Settings.ClickDelay or 0)
                            temp_RegisterHit:FireServer(BasePart, OthersEnemies)
                        end

                        task.spawn(function()
                            while true do
                                task.wait(Settings.ClickDelay)
                                if Settings.AutoClick and FastAttack.IsRunning then
                                    FastAttack:BladeHits()
                                else
                                    task.wait(0.1)
                                end
                            end
                        end)

                        _ENV.rz_FastAttack = FastAttack
                        return FastAttack
                    end)()
                end
            end
        end
    end
end)
